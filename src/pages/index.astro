---
import { getCollection, getEntry } from 'astro:content';
import type { CollectionEntry } from 'astro:content'; // 引入类型
import '../styles/global.css';

// 书籍类型定义
interface Book { title: string; cover: string; status: string; link?: string; }

// 1. 获取花园数据 (显式指定类型)
const allPosts: CollectionEntry<'garden'>[] = await getCollection('garden');

// 修复报错：给 a 和 b 指定类型
const gardenPosts = allPosts.sort((a: CollectionEntry<'garden'>, b: CollectionEntry<'garden'>) => {
  return b.data.date.valueOf() - a.data.date.valueOf();
});

// 2. 获取进度数据
const progressEntry = await getEntry('specialized', 'progress');
if (!progressEntry) { throw new Error("Missing src/content/specialized/progress.md"); }
const books = progressEntry.data.books as Book[]; 
const rawContent = progressEntry.body; 

// 进度计算
const totalTasks = (rawContent.match(/- \[[x ]\]/g) || []).length;
const doneTasks = (rawContent.match(/- \[x\]/g) || []).length;
const percentage = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
const currentTask = rawContent.match(/- \[ \] (.*)/)?.[1] || "Finalizing...";

// 图标辅助
function getStatusIcon(status: string): string {
  switch(status) {
    case 'evergreen': return '/icons/evergreen.svg';
    case 'budding': return '/icons/budding.svg';
    default: return '/icons/seed.svg';
  }
}
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Jeambo</title>
  </head>
  
  <body>
    <main class="container">
      
      <header style="margin-bottom: 6rem; text-align: center;">
        <img src="/header.svg" alt="Jeambo" style="height: 100px; opacity: 0.9;" />
      </header>

      <section style="margin-bottom: 5rem;">
        <p style="font-size: 1.2rem; color: var(--text-main);">
          我是 Jeambo。非单偶制关系实践者，译者。<br>
          创建了中文多元关系文库 <a href="https://polycn.org" target="_blank" style="border-bottom: 1px solid var(--accent);">PolyCN.org</a>。<br>
          在秩序与混沌之间，寻找爱的更多可能。
        </p>
      </section>

      <hr class="divider" />

      <section style="margin-bottom: 5rem;">
        <h2 class="font-ui" style="font-size: 0.75rem; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 2rem;">TRANSLATIONS</h2>
        
        <div class="scrollbar-hide" style="display: flex; gap: 2rem; overflow-x: auto; padding-bottom: 1rem;">
          {books.filter((b: Book) => b.status === 'completed').map((book: Book) => (
            <a href={book.link} target="_blank" style="flex: 0 0 120px; display: block;">
              <div style="width: 120px; height: 180px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 1rem;">
                <img src={book.cover} alt={book.title} style="width: 100%; height: 100%; object-fit: cover; filter: grayscale(20%); transition: 0.3s;" onmouseover="this.style.filter='grayscale(0)'" onmouseout="this.style.filter='grayscale(20%)'"/>
              </div>
              <p class="font-ui" style="font-size: 0.85rem; font-weight: 500;">{book.title}</p>
            </a>
          ))}
        </div>
      </section>

      <section style="margin-bottom: 5rem;">
        <div style="display: flex; align-items: baseline; gap: 1rem; margin-bottom: 1rem;">
          <h2 class="font-ui" style="font-size: 0.75rem; letter-spacing: 0.1em; color: var(--text-muted); margin: 0;">CURRENT FOCUS</h2>
          <span class="font-ui" style="font-size: 3rem; font-weight: 300; line-height: 1; color: var(--accent);">{percentage}%</span>
        </div>
        
        <div style="margin-bottom: 0.5rem;">
          <span style="font-size: 1.1rem; font-style: italic;">More Than Two</span>
        </div>

        <div class="progress-track">
          <div class="progress-fill" style={`width: ${percentage}%;`}></div>
        </div>
        
        <div class="font-ui" style="margin-top: 0.8rem; font-size: 0.8rem; color: var(--text-muted);">
          Processing: {currentTask}
        </div>
      </section>

      <hr class="divider" />

      <section>
        <h2 class="font-ui" style="font-size: 0.75rem; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 2rem;">DIGITAL GARDEN</h2>
        
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
          {gardenPosts.map((post: CollectionEntry<'garden'>) => (
            <a href={`/garden/${post.slug}`} style="display: flex; align-items: baseline; group">
              <img src={getStatusIcon(post.data.status)} style="width: 16px; height: 16px; opacity: 0.6; margin-right: 1rem; transform: translateY(2px);" />
              
              <span style="font-size: 1.1rem; border-bottom: 1px dashed var(--line-color); padding-bottom: 2px; transition: border-color 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--line-color)'">
                {post.data.title}
              </span>
              
              <span class="font-ui" style="margin-left: auto; font-size: 0.8rem; color: var(--text-muted);">
                {post.data.date.toISOString().split('T')[0]}
              </span>
            </a>
          ))}
        </div>
      </section>

      <footer class="font-ui" style="margin-top: 6rem; text-align: center; font-size: 0.75rem; color: var(--text-muted);">
        <p>CC BY-NC-SA 4.0 © 2025 Jeambo</p>
        <p style="margin-top: 0.5rem;"><a href="mailto:jeambo@polycn.org">jeambo@polycn.org</a></p>
      </footer>
    </main>
  </body>
</html>